<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pengembalian - Perpustakaan SDN Poris Pelawad 6</title>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Reset dasar untuk semua elemen */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    /* Warna latar belakang halaman */
    body {
      background-color: #f8f9fa;
    }

    /* Navigasi atas */
    .navbar {
      width: 100%;
      height: 60px;
      background: #1E2A38;
      color: white;
      display: flex;
      align-items: center;
      padding: 0 20px;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
    }

    .menu-icon {
      font-size: 24px;
      cursor: pointer;
    }

    .right-section {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
    }

    .navbar i.user-icon {
      font-size: 30px;
    }

    .navbar h1 {
      font-size: 20px;
      font-weight: bold;
      margin: 0;
    }

    /* Sidebar kiri */
    .sidebar {
      width: 250px;
      background: #2F4050;
      color: white;
      height: 100vh;
      padding-top: 80px;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 999;
      overflow-y: auto;
      transition: transform 0.3s ease;
    }

    .sidebar.hide {
      transform: translateX(-100%);
    }

    /* Profil admin di sidebar */
    .admin-profile {
      text-align: center;
      margin-bottom: 20px;
    }

    .admin-image {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 10px;
    }

    .admin-profile::after {
      content: "";
      display: block;
      width: 100%;
      height: 2px;
       background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.5), transparent);
      margin-top: 10px;
    }

    .admin-name {
      font-size: 18px;
      font-weight: bold;
      color: #fff;
    }

    /* Daftar menu sidebar */
    .menu-list li {
      margin: 8px 0;
    }

    .menu-list li a {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      text-decoration: none;
      color: white;
      font-size: 16px;
      font-weight: bold;
      transition: background 0.3s ease;
    }

    .menu-list li a:hover,
    .menu-list li a.active {
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }

    .menu-list li a i {
      width: 25px;
      text-align: center;
      font-size: 18px;
    }

    /* Konten utama */
    .main-content {
      padding: 80px 20px 20px 20px;
      margin-left: 250px;
      transition: margin-left 0.3s ease, width 0.3s ease;
    }

    .main-content.full {
      margin-left: 0;
    }

    /* Judul halaman */
    h2 {
      text-align: center;
      color: #2980B9;
      margin-bottom: 20px;
      font-size: 30px;
    }

    /* Area pencarian dan filter */
    .search-container, .filter-container {
      margin: 20px 0 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .search-container {
      position: relative;
      width: 300px;
    }

    .search-container input[type="text"] {
      width: 100%;
      height: 40px;
      padding: 8px 36px 8px 12px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .search-container .search-icon {
      position: absolute;
      top: 50%;
      right: 12px;
      transform: translateY(-50%);
      color: #888;
      font-size: 16px;
      pointer-events: none;
    }

    /* Top bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
      gap: 10px;
    }

    .left-group {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .filter-container label {
      font-size: 14px;
    }

    .filter-container select,
    .filter-container input[type="text"] {
      height: 38px;
      padding: 0 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      line-height: 1;
    }

    /* Tombol ikon */
    .icon-button {
      width: 38px;
      height: 38px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      padding: 0;
    }

    .icon-button.download { background-color: #4CAF50; }
    .icon-button.undo { background-color: #3498DB; }
    .icon-button.delete { background-color: #E74C3C; } /* Tetap merah */

    .icon-button:hover {
      opacity: 0.85;
    }

    .right-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    /* Tabel responsif */
    .table-responsive {
      overflow-x: auto;
      width: 100%;
      transition: width 0.3s ease;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      min-width: 800px;
    }

    th, td {
      padding: 12px;
      text-align: center;
      border: 1px solid #ddd;
    }

    th {
      background-color: #2980B9;
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    /* Tombol kembali */
    .back-btn {
      display: inline-block;
      margin-top: 20px;
      text-decoration: none;
      background-color: #2F4050;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
    }

    .back-btn:hover {
      background-color: #1E6FA3;
    }

    /* Total denda */
    .total-denda {
      margin-top: 15px;
      font-size: 18px;
      font-weight: bold;
      color: #2980B9;
      text-align: right;
    }

    /* Responsif: tablet */
    @media (max-width: 768px) {
      .sidebar {
        width: 200px;
      }

      .main-content {
        margin-left: 200px;
      }

      .main-content.full {
        margin-left: 0;
      }

      .navbar h1 {
        font-size: 16px;
      }

      .menu-icon {
        margin-right: 10px;
      }

      .button-container {
        flex-direction: column;
        gap: 10px;
      }
    }

    /* Responsif: HP */
    @media (max-width: 480px) {
      .navbar h1 {
        font-size: 14px;
      }

      .button-container button {
        font-size: 14px;
        padding: 8px;
      }

      th, td {
        font-size: 12px;
        padding: 8px;
      }

      h2 {
        font-size: 22px;
      }

      .back-btn {
        font-size: 14px;
        padding: 8px 12px;
        background-color: #2980B9; /* Tombol biru */
        color: white;
      }

       .back-btn:hover {
          background-color: #1E6FA3;
      }

      .top-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .left-group,
      .right-group {
        justify-content: space-between;
        width: 100%;
      }

      .filter-container {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
        width: 100%;
      }

      .filter-container label {
        margin-bottom: 4px;
      }

      .filter-container select,
      .filter-container input {
        width: 100%;
      }

      .right-group {
        justify-content: flex-end;
      }
    }
  </style>

</head>
<body>
<div class="navbar">
  <span class="menu-icon" onclick="toggleSidebar()">☰</span>
  <div class="right-section">
    <i class="fa fa-user"></i>
    <h1>ADMIN PERPUSTAKAAN</h1>
  </div>
</div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <ul class="menu-list">
    <div class="admin-profile">
      <img src="https://i.pravatar.cc/80?img=12" alt="Profil Admin" class="admin-image">
      <p class="admin-name">ANISA AMELIA</p>
    </div>
    <ul class="nav">
      <li><a th:href="@{/admin-perpustakaan/perpus-panel}" class="nav-link"><i class="fas fa-home"></i> Beranda</a></li>
      <li><a th:href="@{/admin-perpustakaan/data-buku}" class="nav-link"><i class="fas fa-book"></i> Buku</a></li>
      <li><a th:href="@{/admin-perpustakaan/data-pengunjung}" class="nav-link"><i class="fas fa-users"></i> Pengunjung</a></li> <!-- Tambahan -->
      <li><a th:href="@{/admin-perpustakaan/data-peminjaman}" class="nav-link"><i class="fas fa-user-check"></i> Peminjam</a></li>
      <li><a th:href="@{/admin-perpustakaan/data-pengembalian}" class="nav-link"><i class="fas fa-undo-alt"></i> Pengembalian</a></li>
      <li><a th:href="@{/admin-perpustakaan/laporan}" class="nav-link"><i class="fas fa-exchange-alt"></i> Laporan</a></li>
      <li><a href="#" onclick="confirmLogout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
  </ul>
</div>

<div class="main-content" id="content">
  <h2>Data Pengembalian Buku</h2>

  <div class="search-container">
    <input type="text" id="searchInput" onkeyup="filterNamaPeminjam()" placeholder="Cari nama Peminjam">
    <i class="fas fa-search search-icon"></i>
  </div>

  <div class="top-bar">
    <div class="left-group">
      <div class="filter-container">
        <label for="filter-tahun">Filter Tahun Pengembalian:</label>
        <select id="filter-tahun" onchange="filterTahunPengembalian()">
          <option value="semua">Semua</option>
          <option value="2023">2023</option>
          <option value="2024">2024</option>
          <option value="2025">2025</option>
        </select>
      </div>
      <button onclick="downloadTable()" class="icon-button download" title="Download CSV">
        <i class="fas fa-download"></i>
      </button>
    </div>

    <div class="right-group">
      <form action="/admin-perpustakaan/hapus-semua-pengembalian" method="post" style="display: inline;">
        <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
        <button type="submit" class="icon-button delete" title="Hapus Semua">
          <i class="fas fa-trash-alt"></i>
        </button>
      </form>
    </div>
  </div>

  <div class="table-responsive">
    <table id="tabelPengembalian" class="styled-table">
      <thead>
      <tr>
        <th>No</th>
        <th>Nama Peminjam</th>
        <th>Nama Buku</th>
        <th>Tgl Pinjam</th>
        <th>Tgl Kembali</th>
        <th>Tgl Pengembalian</th>
        <th>Denda</th>
      </tr>
      </thead>
      <tbody>
      <tr th:if="${#lists.isEmpty(daftarPengembalian)}">
        <td colspan="7" style="text-align: center;">Belum ada data pengembalian.</td>
      </tr>
      <tr th:each="pengembalian, stat : ${daftarPengembalian}">
        <td th:text="${stat.index + 1}">1</td>
        <td th:text="${pengembalian.namaPeminjam}">Nama</td>
        <td th:text="${pengembalian.namaBuku}">Buku</td>
        <td th:text="${pengembalian.tglPinjam}">2024-01-01</td>
        <td th:text="${pengembalian.tglKembali}">2024-01-10</td>
        <td th:text="${pengembalian.tglPengembalian}">2024-01-11</td>
        <td th:text="'Rp ' + ${pengembalian.denda}">Rp 0</td>
      </tr>
      </tbody>
    </table>
  </div>

  <p id="totalDenda" class="total-denda">Total Denda: <span th:text="'Rp ' + ${totalDenda}">Rp 0</span></p>
  <a class="back-btn" href="/admin-perpustakaan/perpus-panel">← Kembali ke Beranda</a>
</div>

<script>
  function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    const content = document.getElementById("content");
    sidebar.classList.toggle("hide");
    content.classList.toggle("full");
  }

  // Search Function
  function searchTable() {
    const searchInput = document.getElementById("searchInput").value.toLowerCase();
    const rows = document.getElementById("tabelPengembalian").getElementsByTagName("tr");

    for (let i = 1; i < rows.length; i++) {
      const cell = rows[i].getElementsByTagName("td")[1];
      if (cell) {
        const text = cell.textContent || cell.innerText;
        rows[i].style.display = text.toLowerCase().includes(searchInput) ? "" : "none";
      }
    }
  }

function filterTahunPengembalian() {
  const tahun = document.getElementById("TahunFilter")?.value || document.getElementById("filter-tahun")?.value;
  const rows = document.querySelectorAll("#tabelPengembalian tbody tr");

  rows.forEach(row => {
    const tglPengembalian = row.cells[5].textContent;
    const tahunPengembalian = new Date(tglPengembalian).getFullYear().toString();

    if (!tahun || tahun === "semua" || tahunPengembalian === tahun) {
      row.style.display = "";
    } else {
      row.style.display = "none";
    }
  });
}

  function downloadTable() {
    let table = document.getElementById("tabelPengembalian");
    let rows = Array.from(table.rows);
    let csv = rows.map(row =>
      Array.from(row.cells).map(cell => `${cell.innerText}`).join(",")
    ).join("\n");

    let blob = new Blob([csv], { type: "text/csv" });
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "data_pengembalian.csv";
    link.click();
  }

  function confirmLogout() {
    Swal.fire({
      title: 'Yakin ingin logout?',
      text: "Kamu akan keluar dari sistem.",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Ya, logout',
      cancelButtonText: 'Batal'
    }).then((result) => {
      if (result.isConfirmed) {
        window.location.href = "/login";
      }
    });
  }

  function formatTanggal(tgl) {
    const tanggal = new Date(tgl);
    const options = { day: '2-digit', month: 'long', year: 'numeric' };
    return tanggal.toLocaleDateString('id-ID', options);
  }

  function loadDataPengembalian() {
    const data = JSON.parse(localStorage.getItem('dataPengembalian')) || [];
    const tbody = document.querySelector('#tabelPengembalian tbody');
    const totalDendaEl = document.getElementById("totalDenda");
    tbody.innerHTML = '';
    let totalDenda = 0;

    data.forEach((item, index) => {
      const tr = document.createElement('tr');
      const dendaValue = parseInt(item.denda) || 0;
      totalDenda += dendaValue;

      tr.innerHTML = `
        <td>${index + 1}</td>
        <td>${item.namaPeminjam}</td>
        <td>${item.namaBuku}</td>
        <td>${formatTanggal(item.tglPinjam)}</td>
        <td>${formatTanggal(item.tglKembali)}</td>
        <td>${formatTanggal(item.tglPengembalianSebenarnya)}</td>
        <td>${dendaValue > 0 ? 'Rp ' + dendaValue.toLocaleString('id-ID') : '-'}</td>
      `;
      tbody.appendChild(tr);
    });

    if (totalDendaEl) {
      totalDendaEl.textContent = `Total Denda: Rp ${totalDenda.toLocaleString('id-ID')}`;
    }
  }

  function hapusSemua() {
    if (confirm("Yakin ingin menghapus semua data pengembalian?")) {
      const dataSebelumnya = localStorage.getItem("dataPengembalian");
      sessionStorage.setItem("backupPengembalian", dataSebelumnya);
      localStorage.removeItem("dataPengembalian");
      loadDataPengembalian();
      alert("Data dihapus. Klik Undo untuk mengembalikan.");
    }
  }

  function undoPenghapusan() {
    const backup = sessionStorage.getItem("backupPengembalian");
    if (backup) {
      localStorage.setItem("dataPengembalian", backup);
      loadDataPengembalian();
      sessionStorage.removeItem("backupPengembalian");
      alert("Data berhasil dikembalikan!");
    } else {
      alert("Tidak ada data yang bisa dikembalikan.");
    }
  }
</script>
</body>
</html>